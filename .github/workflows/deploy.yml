name: Deploy Mini Programs

on:
  push:
    branches: [master, main]
    tags: ["v*"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # tag 推送时：提交审核（需要审批保护）
    # main 分支推送时：预览版（不需要审批）
    # 注意：需要在 GitHub 仓库设置中为 production environment 配置审批保护
    # Settings -> Environments -> production -> Required reviewers
    if: |
      github.event_name == 'push' &&
      (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    environment:
      name: production
      # 如果需要 URL，可以在这里配置（可选）
      # url: https://your-production-url.com
    steps:
      - uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install miniprogram-ci
        run: pnpm add -D miniprogram-ci

      - name: Type check
        run: pnpm type:check

      - name: Write private keys
        run: |
          mkdir -p key
          # 微信小程序私钥
          if [ -n "${{ secrets.WEAPP_PRIVATE_KEY }}" ]; then
            echo "${{ secrets.WEAPP_PRIVATE_KEY }}" > key/private.${{ secrets.WEAPP_APPID }}.key
          fi
          # 支付宝小程序私钥
          if [ -n "${{ secrets.ALIPAY_PRIVATE_KEY }}" ] && [ -n "${{ secrets.ALIPAY_APPID }}" ]; then
            echo "${{ secrets.ALIPAY_PRIVATE_KEY }}" > key/private.${{ secrets.ALIPAY_APPID }}.key
          fi

      - name: Get version info
        id: version
        run: |
          # 格式：YYYYMMDD-HHMMSS-COMMIT_HASH
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          AUTO_VERSION="${TIMESTAMP}-${COMMIT_SHA}"
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            VERSION="${AUTO_VERSION}"
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "desc=CI 自动构建 ${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Update taroConfig version
        run: |
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.taroConfig = pkg.taroConfig || {};
            pkg.taroConfig.version = '${{ steps.version.outputs.version }}';
            pkg.taroConfig.desc = pkg.description || 'CI 自动构建 ${{ steps.version.outputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            console.log('Updated taroConfig:', pkg.taroConfig);
          "

      # 合并到 main 分支：提交预览版
      - name: Build and preview (微信小程序 - 预览版)
        if: steps.version.outputs.is_release == 'false'
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_WEAPP_APPID: ${{ secrets.WEAPP_APPID }}
          WEAPP_DEVELOPER: heliannuuthus
        run: pnpm build:weapp --mode production --preview
        continue-on-error: true

      - name: Build and preview (抖音小程序 - 预览版)
        if: steps.version.outputs.is_release == 'false'
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_TT_APPID: ${{ secrets.TT_APPID }}
          TT_EMAIL: ${{ secrets.TT_EMAIL }}
          TT_PASSWORD: ${{ secrets.TT_PASSWORD }}
        run: |
          if [ -n "$TARO_APP_TT_APPID" ]; then
            pnpm build:tt --mode production --preview
          else
            echo "跳过抖音小程序构建（未配置 TT_APPID）"
          fi
        continue-on-error: true

      - name: Build and preview (支付宝小程序 - 预览版)
        if: steps.version.outputs.is_release == 'false'
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_ALIPAY_APPID: ${{ secrets.ALIPAY_APPID }}
          ALIPAY_TOOL_ID: ${{ secrets.ALIPAY_TOOL_ID }}
        run: |
          if [ -n "$TARO_APP_ALIPAY_APPID" ]; then
            pnpm build:alipay --mode production --preview
          else
            echo "跳过支付宝小程序构建（未配置 ALIPAY_APPID）"
          fi
        continue-on-error: true

      # 打 tag 后：提交代码审核（需要审批保护）
      - name: Build and upload (微信小程序 - 提交审核)
        if: steps.version.outputs.is_release == 'true'
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_WEAPP_APPID: ${{ secrets.WEAPP_APPID }}
          WEAPP_DEVELOPER: heliannuuthus
        run: pnpm build:weapp --mode production --upload
        continue-on-error: true

      - name: Build and upload (抖音小程序 - 提交审核)
        if: steps.version.outputs.is_release == 'true'
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_TT_APPID: ${{ secrets.TT_APPID }}
          TT_EMAIL: ${{ secrets.TT_EMAIL }}
          TT_PASSWORD: ${{ secrets.TT_PASSWORD }}
        run: |
          if [ -n "$TARO_APP_TT_APPID" ]; then
            pnpm build:tt --mode production --upload
          else
            echo "跳过抖音小程序构建（未配置 TT_APPID）"
          fi
        continue-on-error: true

      - name: Build and upload (支付宝小程序 - 提交审核)
        if: steps.version.outputs.is_release == 'true'
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_ALIPAY_APPID: ${{ secrets.ALIPAY_APPID }}
          ALIPAY_TOOL_ID: ${{ secrets.ALIPAY_TOOL_ID }}
        run: |
          if [ -n "$TARO_APP_ALIPAY_APPID" ]; then
            pnpm build:alipay --mode production --upload
          else
            echo "跳过支付宝小程序构建（未配置 ALIPAY_APPID）"
          fi
        continue-on-error: true
