name: Deploy Mini Programs

on:
  push:
    tags: ["v*"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # 只在 tag 推送时部署，避免每次合并 main 都触发部署
    # 注意：需要在 GitHub 仓库设置中为 production environment 配置审批保护
    # Settings -> Environments -> production -> Required reviewers
    if: startsWith(github.ref, 'refs/tags/')
    environment:
      name: production
      # 如果需要 URL，可以在这里配置（可选）
      # url: https://your-production-url.com
    steps:
      - uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install miniprogram-ci
        run: pnpm add -D miniprogram-ci

      - name: Type check
        run: pnpm type:check

      - name: Write private keys
        run: |
          mkdir -p key
          # 微信小程序私钥
          if [ -n "${{ secrets.WEAPP_PRIVATE_KEY }}" ]; then
            echo "${{ secrets.WEAPP_PRIVATE_KEY }}" > key/private.${{ secrets.WEAPP_APPID }}.key
          fi
          # 支付宝小程序私钥
          if [ -n "${{ secrets.ALIPAY_PRIVATE_KEY }}" ] && [ -n "${{ secrets.ALIPAY_APPID }}" ]; then
            echo "${{ secrets.ALIPAY_PRIVATE_KEY }}" > key/private.${{ secrets.ALIPAY_APPID }}.key
          fi

      - name: Get version info
        id: version
        run: |
          # 只在 tag 推送时触发，所以版本直接从 tag 获取
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "desc=CI 自动构建 ${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Update taroConfig version
        run: |
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.taroConfig = pkg.taroConfig || {};
            pkg.taroConfig.version = '${{ steps.version.outputs.version }}';
            pkg.taroConfig.desc = pkg.description || 'CI 自动构建 ${{ steps.version.outputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            console.log('Updated taroConfig:', pkg.taroConfig);
          "

      # 只在 tag 推送时触发，直接提交代码审核
      - name: Build and upload (微信小程序 - 提交审核)
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_WEAPP_APPID: ${{ secrets.WEAPP_APPID }}
          WEAPP_DEVELOPER: heliannuuthus
        run: pnpm build:weapp --upload
        continue-on-error: true

      - name: Build and upload (抖音小程序 - 提交审核)
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_TT_APPID: ${{ secrets.TT_APPID }}
          TT_EMAIL: ${{ secrets.TT_EMAIL }}
          TT_PASSWORD: ${{ secrets.TT_PASSWORD }}
        run: |
          if [ -n "$TARO_APP_TT_APPID" ]; then
            pnpm build:tt --upload
          else
            echo "跳过抖音小程序构建（未配置 TT_APPID）"
          fi
        continue-on-error: true

      - name: Build and upload (支付宝小程序 - 提交审核)
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_ALIPAY_APPID: ${{ secrets.ALIPAY_APPID }}
          ALIPAY_TOOL_ID: ${{ secrets.ALIPAY_TOOL_ID }}
        run: |
          if [ -n "$TARO_APP_ALIPAY_APPID" ]; then
            pnpm build:alipay --upload
          else
            echo "跳过支付宝小程序构建（未配置 ALIPAY_APPID）"
          fi
        continue-on-error: true
