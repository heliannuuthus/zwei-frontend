name: Deploy WeApp

on:
  push:
    branches: [master, main]
    tags: ["v*"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install miniprogram-ci
        run: pnpm add -D miniprogram-ci

      - name: Type check
        run: pnpm type:check

      - name: Write private key
        run: |
          mkdir -p key
          echo "${{ secrets.WEAPP_PRIVATE_KEY }}" > key/private.${{ secrets.WEAPP_APPID }}.key

      - name: Get version info
        id: version
        run: |
          # 格式：YYYYMMDD-HHMMSS-COMMIT_HASH
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          AUTO_VERSION="${TIMESTAMP}-${COMMIT_SHA}"
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            VERSION="${AUTO_VERSION}"
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "desc=CI 自动构建 ${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Update taroConfig version
        run: |
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.taroConfig = pkg.taroConfig || {};
            pkg.taroConfig.version = '${{ steps.version.outputs.version }}';
            pkg.taroConfig.desc = '${{ steps.version.outputs.desc }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            console.log('Updated taroConfig:', pkg.taroConfig);
          "

      - name: Build and upload (开发版)
        if: steps.version.outputs.is_release == 'false'
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_WEAPP_APPID: ${{ secrets.WEAPP_APPID }}
        run: pnpm build:weapp --upload

      - name: Build and upload (体验版 - 待审核)
        if: steps.version.outputs.is_release == 'true'
        env:
          TARO_APP_API_BASE_URL: ${{ vars.API_BASE_URL }}
          TARO_APP_WEAPP_APPID: ${{ secrets.WEAPP_APPID }}
        run: pnpm build:weapp --upload
